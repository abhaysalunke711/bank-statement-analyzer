{% extends "base.html" %}

{% block title %}Upload Bank Statements - Bank Statement Analyzer{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <!-- Hero Section -->
        <div class="text-center mb-5">
            <h1 class="display-4 fw-bold text-primary mb-3">
                <i class="fas fa-file-invoice-dollar"></i>
                Bank Statement Analyzer
            </h1>
            <p class="lead text-muted">
                Upload your PDF bank statements and get intelligent analysis with category-wise breakdowns, 
                monthly summaries, and beautiful visualizations.
            </p>
        </div>



        <!-- Upload Card -->
        <div class="card mb-5">
            <div class="card-body">
                <h3 class="card-title text-center mb-4">
                    <i class="fas fa-cloud-upload-alt text-primary"></i>
                    Upload Bank Statement PDFs
                </h3>
                
                <form action="{{ url_for('upload_files') }}" method="POST" enctype="multipart/form-data" id="uploadForm">
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-content">
                            <i class="fas fa-file-pdf fa-3x text-primary mb-3"></i>
                            <h5>Drag & Drop PDF files here</h5>
                            <p class="text-muted">or click to browse</p>
                            <input type="file" name="files" id="fileInput" multiple accept=".pdf" class="d-none">
                            <button type="button" class="btn btn-primary" id="browseBtn">
                                <i class="fas fa-folder-open me-2"></i>
                                Browse Files
                            </button>
                        </div>
                    </div>
                    
                    <!-- Selected Files Display -->
                    <div id="selectedFiles" class="mt-3" style="display: none;">
                        <h6>Selected Files:</h6>
                        <div id="fileList" class="list-group"></div>
                    </div>
                    
                    <!-- Upload Button -->
                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-success btn-lg" id="uploadBtn" disabled>
                            <i class="fas fa-analytics me-2"></i>
                            Analyze Bank Statements
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Features Section -->
        <div class="row mb-5">
            <div class="col-md-4 text-center mb-4">
                <div class="feature-icon">
                    <i class="fas fa-tags"></i>
                </div>
                <h5>Smart Categorization</h5>
                <p class="text-muted">Automatically categorizes transactions into Food, Shopping, Transportation, and more.</p>
            </div>
            <div class="col-md-4 text-center mb-4">
                <div class="feature-icon">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <h5>Monthly Organization</h5>
                <p class="text-muted">Organizes your data by month with separate tabs for easy analysis.</p>
            </div>
            <div class="col-md-4 text-center mb-4">
                <div class="feature-icon">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <h5>Visual Reports</h5>
                <p class="text-muted">Generates charts and comprehensive Excel reports with summaries.</p>
            </div>
        </div>

        <!-- Instructions -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-info-circle text-info"></i>
                    How to Use
                </h5>
                <ol class="mb-0">
                    <li><strong>Upload PDFs:</strong> Select one or more bank statement PDF files</li>
                    <li><strong>Automatic Processing:</strong> The system extracts and categorizes all transactions</li>
                    <li><strong>Monthly Reports:</strong> Get Excel files with separate tabs for each month</li>
                    <li><strong>Download Results:</strong> Access your organized financial data and charts</li>
                </ol>
                
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-shield-alt"></i>
                        <strong>Privacy:</strong> All files are processed locally and deleted after analysis.
                        Maximum file size: 16MB per file.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {

    // File upload handling
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const browseBtn = document.getElementById('browseBtn');
    const selectedFiles = document.getElementById('selectedFiles');
    const fileList = document.getElementById('fileList');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadForm = document.getElementById('uploadForm');
    
    let files = [];
    
    // Browse button click - primary file selection method
    browseBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        fileInput.click();
    });
    
    // Upload area click (excluding the button area)
    uploadArea.addEventListener('click', function(e) {
        // Don't trigger if clicking on the browse button or its children
        if (e.target === browseBtn || browseBtn.contains(e.target)) {
            return;
        }
        fileInput.click();
    });
    
    // Drag and drop functionality
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const droppedFiles = Array.from(e.dataTransfer.files);
        handleFiles(droppedFiles);
    });
    
    // File input change
    fileInput.addEventListener('change', function(e) {
        console.log('File input changed, files selected:', e.target.files.length);
        const selectedFiles = Array.from(e.target.files);
        handleFiles(selectedFiles);
    });
    
    // Additional safety - ensure file input is properly reset when needed
    function resetFileInput() {
        fileInput.value = '';
        files = [];
        displaySelectedFiles();
        updateUploadButton();
    }
    
    function handleFiles(newFiles) {
        // Filter PDF files only
        const pdfFiles = newFiles.filter(file => file.type === 'application/pdf');
        
        if (pdfFiles.length !== newFiles.length) {
            alert('Only PDF files are allowed. Non-PDF files have been filtered out.');
        }
        
        files = pdfFiles;
        displaySelectedFiles();
        updateUploadButton();
    }
    
    function displaySelectedFiles() {
        if (files.length === 0) {
            selectedFiles.style.display = 'none';
            return;
        }
        
        selectedFiles.style.display = 'block';
        fileList.innerHTML = '';
        
        files.forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'list-group-item d-flex justify-content-between align-items-center';
            fileItem.innerHTML = `
                <div>
                    <i class="fas fa-file-pdf text-danger me-2"></i>
                    <strong>${file.name}</strong>
                    <small class="text-muted ms-2">(${formatFileSize(file.size)})</small>
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFile(${index})">
                    <i class="fas fa-times"></i>
                </button>
            `;
            fileList.appendChild(fileItem);
        });
    }
    
    function updateUploadButton() {
        uploadBtn.disabled = files.length === 0;
        
        if (files.length > 0) {
            uploadBtn.innerHTML = `
                <i class="fas fa-analytics me-2"></i>
                Analyze ${files.length} File${files.length > 1 ? 's' : ''}
            `;
        } else {
            uploadBtn.innerHTML = `
                <i class="fas fa-analytics me-2"></i>
                Analyze Bank Statements
            `;
        }
    }
    
    window.removeFile = function(index) {
        files.splice(index, 1);
        displaySelectedFiles();
        updateUploadButton();
        
        // Update file input
        const dt = new DataTransfer();
        files.forEach(file => dt.items.add(file));
        fileInput.files = dt.files;
    };
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // Form submission with progress
    uploadForm.addEventListener('submit', function(e) {
        if (files.length === 0) {
            e.preventDefault();
            alert('Please select at least one PDF file.');
            return;
        }
        
        // Update file input with current files
        const dt = new DataTransfer();
        files.forEach(file => dt.items.add(file));
        fileInput.files = dt.files;
        
        // Show loading state
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = `
            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
            Processing...
        `;
        
        // Create progress indicator
        const progressDiv = document.createElement('div');
        progressDiv.className = 'mt-4';
        progressDiv.innerHTML = `
            <div class="progress mb-3" style="height: 20px;">
                <div id="uploadProgress" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                     role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
            </div>
            <div id="processingSteps" class="processing-steps">
                <div class="processing-step mb-2 text-muted">
                    <i class="fas fa-file-pdf text-primary me-2"></i>
                    <span>Extracting text from PDFs</span>
                    <i class="fas fa-check text-success ms-2 d-none"></i>
                </div>
                <div class="processing-step mb-2 text-muted">
                    <i class="fas fa-tags text-primary me-2"></i>
                    <span>Categorizing transactions</span>
                    <i class="fas fa-check text-success ms-2 d-none"></i>
                </div>
                <div class="processing-step mb-2 text-muted">
                    <i class="fas fa-chart-bar text-primary me-2"></i>
                    <span>Generating reports and charts</span>
                    <i class="fas fa-check text-success ms-2 d-none"></i>
                </div>
            </div>
        `;
        uploadBtn.parentNode.appendChild(progressDiv);

        // Simulate progress for better user experience
        let currentProgress = 0;
        const steps = document.querySelectorAll('.processing-step');
        const progressBar = document.getElementById('uploadProgress');
        
        function updateProgress(progress, stepIndex) {
            currentProgress = progress;
            progressBar.style.width = `${progress}%`;
            progressBar.textContent = `${progress}%`;
            progressBar.setAttribute('aria-valuenow', progress);

            // Update step indicators
            steps.forEach((step, index) => {
                if (index < stepIndex) {
                    step.classList.remove('text-muted');
                    step.classList.add('text-success');
                    step.querySelector('.fa-check').classList.remove('d-none');
                } else if (index === stepIndex) {
                    step.classList.remove('text-muted');
                    step.classList.add('text-primary');
                }
            });
        }

        // Simulate the processing steps
        setTimeout(() => updateProgress(15, 0), 500);  // Start PDF extraction
        setTimeout(() => updateProgress(30, 0), 1500); // PDF extraction progress
        setTimeout(() => {
            updateProgress(45, 1);  // Start categorization
            steps[0].querySelector('.fa-check').classList.remove('d-none');
        }, 2500);
        setTimeout(() => updateProgress(60, 1), 3500); // Categorization progress
        setTimeout(() => {
            updateProgress(75, 2);  // Start report generation
            steps[1].querySelector('.fa-check').classList.remove('d-none');
        }, 4500);
        setTimeout(() => updateProgress(90, 2), 5500); // Report generation progress
    });
});
</script>

<style>
/* Fix for file upload button responsiveness */
#browseBtn {
    position: relative;
    z-index: 10;
    pointer-events: auto;
    transition: all 0.2s ease;
}

#browseBtn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,123,255,0.3);
}

#browseBtn:active {
    transform: translateY(0);
}

/* Ensure upload area doesn't interfere with button clicks */
.upload-area {
    position: relative;
    cursor: pointer;
}

.upload-content {
    position: relative;
    z-index: 1;
}

/* Prevent text selection on upload area */
.upload-area {
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}

/* File input debugging - remove in production */
#fileInput {
    position: absolute !important;
    left: -9999px !important;
    visibility: hidden !important;
}



/* Enhanced drag over effect */
.upload-area.dragover {
    background-color: #e3f2fd;
    border-color: #2196f3;
    transform: scale(1.02);
    transition: all 0.3s ease;
}

/* Processing steps styling */
.processing-steps {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    border: 1px solid #dee2e6;
}

.processing-step {
    display: flex;
    align-items: center;
    padding: 0.5rem;
    border-radius: 4px;
    transition: all 0.3s ease;
}

.processing-step.text-primary {
    background: rgba(33, 150, 243, 0.1);
}

.processing-step.text-success {
    background: rgba(40, 167, 69, 0.1);
}

.processing-step i.fa-check {
    opacity: 0;
    transform: scale(0);
    transition: all 0.3s ease;
}

.processing-step i.fa-check:not(.d-none) {
    opacity: 1;
    transform: scale(1);
}

/* Progress bar enhancements */
.progress {
    background-color: #e9ecef;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
}

.progress-bar {
    background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
    box-shadow: 0 2px 5px rgba(33, 150, 243, 0.3);
    font-weight: 600;
    font-size: 0.875rem;
    line-height: 20px;
    transition: width 0.5s ease;
}
</style>
{% endblock %}
