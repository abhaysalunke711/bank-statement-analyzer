{% extends "base.html" %}

{% block title %}Upload Bank Statements - Bank Statement Analyzer{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <!-- Hero Section -->
        <div class="text-center mb-5">
            <h1 class="display-4 fw-bold text-primary mb-3">
                <i class="fas fa-file-invoice-dollar"></i>
                Bank Statement Analyzer
            </h1>
            <p class="lead text-muted">
                Upload your PDF bank statements and get intelligent analysis with category-wise breakdowns, 
                monthly summaries, and beautiful visualizations.
            </p>
        </div>

        <!-- Analytics Section -->
        <div class="row mb-5">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-chart-line text-primary me-2"></i>
                            Monthly Expenses Trend
                        </h5>
                        <div class="chart-container" style="position: relative; height: 300px;">
                            <canvas id="expensesChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-chart-line text-success me-2"></i>
                            Monthly Income Trend
                        </h5>
                        <div class="chart-container" style="position: relative; height: 300px;">
                            <canvas id="incomeChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upload Card -->
        <div class="card mb-5">
            <div class="card-body">
                <h3 class="card-title text-center mb-4">
                    <i class="fas fa-cloud-upload-alt text-primary"></i>
                    Upload Bank Statement PDFs
                </h3>
                
                <form action="{{ url_for('upload_files') }}" method="POST" enctype="multipart/form-data" id="uploadForm">
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-content">
                            <i class="fas fa-file-pdf fa-3x text-primary mb-3"></i>
                            <h5>Drag & Drop PDF files here</h5>
                            <p class="text-muted">or click to browse</p>
                            <input type="file" name="files" id="fileInput" multiple accept=".pdf" class="d-none">
                            <button type="button" class="btn btn-primary" id="browseBtn">
                                <i class="fas fa-folder-open me-2"></i>
                                Browse Files
                            </button>
                        </div>
                    </div>
                    
                    <!-- Selected Files Display -->
                    <div id="selectedFiles" class="mt-3" style="display: none;">
                        <h6>Selected Files:</h6>
                        <div id="fileList" class="list-group"></div>
                    </div>
                    
                    <!-- Upload Button -->
                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-success btn-lg" id="uploadBtn" disabled>
                            <i class="fas fa-analytics me-2"></i>
                            Analyze Bank Statements
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Features Section -->
        <div class="row mb-5">
            <div class="col-md-4 text-center mb-4">
                <div class="feature-icon">
                    <i class="fas fa-tags"></i>
                </div>
                <h5>Smart Categorization</h5>
                <p class="text-muted">Automatically categorizes transactions into Food, Shopping, Transportation, and more.</p>
            </div>
            <div class="col-md-4 text-center mb-4">
                <div class="feature-icon">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <h5>Monthly Organization</h5>
                <p class="text-muted">Organizes your data by month with separate tabs for easy analysis.</p>
            </div>
            <div class="col-md-4 text-center mb-4">
                <div class="feature-icon">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <h5>Visual Reports</h5>
                <p class="text-muted">Generates charts and comprehensive Excel reports with summaries.</p>
            </div>
        </div>

        <!-- Instructions -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-info-circle text-info"></i>
                    How to Use
                </h5>
                <ol class="mb-0">
                    <li><strong>Upload PDFs:</strong> Select one or more bank statement PDF files</li>
                    <li><strong>Automatic Processing:</strong> The system extracts and categorizes all transactions</li>
                    <li><strong>Monthly Reports:</strong> Get Excel files with separate tabs for each month</li>
                    <li><strong>Download Results:</strong> Access your organized financial data and charts</li>
                </ol>
                
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-shield-alt"></i>
                        <strong>Privacy:</strong> All files are processed locally and deleted after analysis.
                        Maximum file size: 16MB per file.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Initialize the charts with empty data
let expensesChart = null;
let incomeChart = null;

function initializeCharts() {
    const expensesCtx = document.getElementById('expensesChart').getContext('2d');
    const incomeCtx = document.getElementById('incomeChart').getContext('2d');

    // Common chart options
    const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return '₹' + value.toLocaleString();
                    }
                }
            }
        },
        plugins: {
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.dataset.label + ': ₹' + context.parsed.y.toLocaleString();
                    }
                }
            }
        }
    };

    // Initialize Expenses Chart
    expensesChart = new Chart(expensesCtx, {
        type: 'line',
        data: {
            labels: [], // Will be populated with months
            datasets: [] // Will be populated with expense categories
        },
        options: {
            ...commonOptions,
            plugins: {
                ...commonOptions.plugins,
                title: {
                    display: true,
                    text: 'Monthly Expenses by Category'
                }
            }
        }
    });

    // Initialize Income Chart
    incomeChart = new Chart(incomeCtx, {
        type: 'line',
        data: {
            labels: [], // Will be populated with months
            datasets: [] // Will be populated with income sources
        },
        options: {
            ...commonOptions,
            plugins: {
                ...commonOptions.plugins,
                title: {
                    display: true,
                    text: 'Monthly Income by Source'
                }
            }
        }
    });
}

// Function to update charts with new data
function updateCharts(data) {
    if (!data) return;

    // Update Expenses Chart
    if (data.expenses) {
        expensesChart.data.labels = data.expenses.months;
        expensesChart.data.datasets = data.expenses.categories.map((category, index) => ({
            label: category.name,
            data: category.values,
            borderColor: getChartColor(index),
            backgroundColor: getChartColor(index, 0.1),
            tension: 0.4
        }));
        expensesChart.update();
    }

    // Update Income Chart
    if (data.income) {
        incomeChart.data.labels = data.income.months;
        incomeChart.data.datasets = data.income.sources.map((source, index) => ({
            label: source.name,
            data: source.values,
            borderColor: getChartColor(index + 5), // Offset to get different colors
            backgroundColor: getChartColor(index + 5, 0.1),
            tension: 0.4
        }));
        incomeChart.update();
    }
}

// Helper function to generate chart colors
function getChartColor(index, alpha = 1) {
    const colors = [
        `rgba(52, 152, 219, ${alpha})`,  // Blue
        `rgba(231, 76, 60, ${alpha})`,   // Red
        `rgba(46, 204, 113, ${alpha})`,  // Green
        `rgba(155, 89, 182, ${alpha})`,  // Purple
        `rgba(241, 196, 15, ${alpha})`,  // Yellow
        `rgba(230, 126, 34, ${alpha})`,  // Orange
        `rgba(52, 73, 94, ${alpha})`,    // Dark Gray
        `rgba(26, 188, 156, ${alpha})`,  // Turquoise
    ];
    return colors[index % colors.length];
}

// Initialize charts when the page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();

    // Example data structure for testing
    const sampleData = {
        expenses: {
            months: ['Jan 2024', 'Feb 2024', 'Mar 2024'],
            categories: [
                {
                    name: 'Food',
                    values: [15000, 16000, 14500]
                },
                {
                    name: 'Transportation',
                    values: [8000, 7500, 8200]
                },
                {
                    name: 'Shopping',
                    values: [12000, 9000, 11000]
                }
            ]
        },
        income: {
            months: ['Jan 2024', 'Feb 2024', 'Mar 2024'],
            sources: [
                {
                    name: 'Salary',
                    values: [50000, 50000, 50000]
                },
                {
                    name: 'Investments',
                    values: [5000, 5500, 6000]
                },
                {
                    name: 'Freelance',
                    values: [10000, 12000, 8000]
                }
            ]
        }
    };

    // Update charts with sample data (this will be replaced with real data)
    updateCharts(sampleData);

    // File upload handling
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const browseBtn = document.getElementById('browseBtn');
    const selectedFiles = document.getElementById('selectedFiles');
    const fileList = document.getElementById('fileList');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadForm = document.getElementById('uploadForm');
    
    let files = [];
    
    // Browse button click - primary file selection method
    browseBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        fileInput.click();
    });
    
    // Upload area click (excluding the button area)
    uploadArea.addEventListener('click', function(e) {
        // Don't trigger if clicking on the browse button or its children
        if (e.target === browseBtn || browseBtn.contains(e.target)) {
            return;
        }
        fileInput.click();
    });
    
    // Drag and drop functionality
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const droppedFiles = Array.from(e.dataTransfer.files);
        handleFiles(droppedFiles);
    });
    
    // File input change
    fileInput.addEventListener('change', function(e) {
        console.log('File input changed, files selected:', e.target.files.length);
        const selectedFiles = Array.from(e.target.files);
        handleFiles(selectedFiles);
    });
    
    // Additional safety - ensure file input is properly reset when needed
    function resetFileInput() {
        fileInput.value = '';
        files = [];
        displaySelectedFiles();
        updateUploadButton();
    }
    
    function handleFiles(newFiles) {
        // Filter PDF files only
        const pdfFiles = newFiles.filter(file => file.type === 'application/pdf');
        
        if (pdfFiles.length !== newFiles.length) {
            alert('Only PDF files are allowed. Non-PDF files have been filtered out.');
        }
        
        files = pdfFiles;
        displaySelectedFiles();
        updateUploadButton();
    }
    
    function displaySelectedFiles() {
        if (files.length === 0) {
            selectedFiles.style.display = 'none';
            return;
        }
        
        selectedFiles.style.display = 'block';
        fileList.innerHTML = '';
        
        files.forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'list-group-item d-flex justify-content-between align-items-center';
            fileItem.innerHTML = `
                <div>
                    <i class="fas fa-file-pdf text-danger me-2"></i>
                    <strong>${file.name}</strong>
                    <small class="text-muted ms-2">(${formatFileSize(file.size)})</small>
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFile(${index})">
                    <i class="fas fa-times"></i>
                </button>
            `;
            fileList.appendChild(fileItem);
        });
    }
    
    function updateUploadButton() {
        uploadBtn.disabled = files.length === 0;
        
        if (files.length > 0) {
            uploadBtn.innerHTML = `
                <i class="fas fa-analytics me-2"></i>
                Analyze ${files.length} File${files.length > 1 ? 's' : ''}
            `;
        } else {
            uploadBtn.innerHTML = `
                <i class="fas fa-analytics me-2"></i>
                Analyze Bank Statements
            `;
        }
    }
    
    window.removeFile = function(index) {
        files.splice(index, 1);
        displaySelectedFiles();
        updateUploadButton();
        
        // Update file input
        const dt = new DataTransfer();
        files.forEach(file => dt.items.add(file));
        fileInput.files = dt.files;
    };
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // Form submission with progress
    uploadForm.addEventListener('submit', function(e) {
        if (files.length === 0) {
            e.preventDefault();
            alert('Please select at least one PDF file.');
            return;
        }
        
        // Update file input with current files
        const dt = new DataTransfer();
        files.forEach(file => dt.items.add(file));
        fileInput.files = dt.files;
        
        // Show loading state
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = `
            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
            Processing...
        `;
        
        // Create progress indicator
        const progressDiv = document.createElement('div');
        progressDiv.className = 'mt-3';
        progressDiv.innerHTML = `
            <div class="progress">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
            </div>
            <small class="text-muted mt-2 d-block">
                <i class="fas fa-cog fa-spin me-1"></i>
                Extracting text from PDFs, categorizing transactions, and generating reports...
            </small>
        `;
        uploadBtn.parentNode.appendChild(progressDiv);
    });
});
</script>

<style>
/* Fix for file upload button responsiveness */
#browseBtn {
    position: relative;
    z-index: 10;
    pointer-events: auto;
    transition: all 0.2s ease;
}

#browseBtn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,123,255,0.3);
}

#browseBtn:active {
    transform: translateY(0);
}

/* Ensure upload area doesn't interfere with button clicks */
.upload-area {
    position: relative;
    cursor: pointer;
}

.upload-content {
    position: relative;
    z-index: 1;
}

/* Prevent text selection on upload area */
.upload-area {
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}

/* File input debugging - remove in production */
#fileInput {
    position: absolute !important;
    left: -9999px !important;
    visibility: hidden !important;
}

/* Chart styles */
.chart-container {
    margin: 10px 0;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.8);
    padding: 10px;
    box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.05);
}

.card .chart-container {
    min-height: 300px;
    transition: all 0.3s ease;
}

.card .chart-container:hover {
    background: rgba(255, 255, 255, 0.95);
    box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.1);
}

/* Enhanced drag over effect */
.upload-area.dragover {
    background-color: #e3f2fd;
    border-color: #2196f3;
    transform: scale(1.02);
    transition: all 0.3s ease;
}
</style>
{% endblock %}
