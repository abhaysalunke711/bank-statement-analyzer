{% extends "base.html" %}

{% block title %}Upload Bank Statements - Bank Statement Analyzer{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <!-- Hero Section -->
        <div class="text-center mb-5">
            <h1 class="display-4 fw-bold text-primary mb-3">
                <i class="fas fa-file-invoice-dollar"></i>
                Bank Statement Analyzer
            </h1>
            <p class="lead text-muted">
                Upload your PDF bank statements and get intelligent analysis with category-wise breakdowns, 
                monthly summaries, and beautiful visualizations.
            </p>
        </div>



        <!-- Upload Card -->
        <div class="card mb-5">
            <div class="card-body">
                <h3 class="card-title text-center mb-4">
                    <i class="fas fa-cloud-upload-alt text-primary"></i>
                    Upload Bank Statement PDFs
                </h3>
                
                <form action="{{ url_for('upload_files') }}" method="POST" enctype="multipart/form-data" id="uploadForm">
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-content text-center">
                            <i id="uploadIcon" class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                            <h5>Drag & Drop Files Here</h5>
                            <p class="text-muted">Bank statements (PDF) or receipts (JPG, PNG)</p>
                            <input type="file" name="files" id="fileInput" multiple accept=".pdf,.jpg,.jpeg,.png" class="d-none">
                            <button type="button" class="btn btn-primary" onclick="document.getElementById('fileInput').click();">
                                <i class="fas fa-folder-open me-2"></i>
                                Browse Files
                            </button>
                        </div>
                    </div>

                    <!-- Selected Files Display -->
                    <div id="selectedFiles" class="mt-4 border rounded p-3 bg-light" style="display: none;">
                        <h6 class="mb-3">
                            <i class="fas fa-folder-open me-2"></i>
                            Selected Files
                        </h6>
                        <div id="fileList" class="list-group"></div>
                    </div>
                    
                    <!-- Upload Button -->
                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-success btn-lg" id="uploadBtn" disabled>
                            <i class="fas fa-analytics me-2"></i>
                            Analyze Bank Statements
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Features Section -->
        <div class="row mb-5">
            <div class="col-md-4 text-center mb-4">
                <div class="feature-icon">
                    <i class="fas fa-tags"></i>
                </div>
                <h5>Smart Categorization</h5>
                <p class="text-muted">Automatically categorizes transactions into Food, Shopping, Transportation, and more.</p>
            </div>
            <div class="col-md-4 text-center mb-4">
                <div class="feature-icon">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <h5>Monthly Organization</h5>
                <p class="text-muted">Organizes your data by month with separate tabs for easy analysis.</p>
            </div>
            <div class="col-md-4 text-center mb-4">
                <div class="feature-icon">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <h5>Visual Reports</h5>
                <p class="text-muted">Generates charts and comprehensive Excel reports with summaries.</p>
            </div>
        </div>

        <!-- Instructions -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-info-circle text-info"></i>
                    How to Use
                </h5>
                <ol class="mb-0">
                    <li><strong>Upload PDFs:</strong> Select one or more bank statement PDF files</li>
                    <li><strong>Automatic Processing:</strong> The system extracts and categorizes all transactions</li>
                    <li><strong>Monthly Reports:</strong> Get Excel files with separate tabs for each month</li>
                    <li><strong>Download Results:</strong> Access your organized financial data and charts</li>
                </ol>
                
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-shield-alt"></i>
                        <strong>Privacy:</strong> All files are processed locally and deleted after analysis.
                        Maximum file size: 16MB per file.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
    <!-- Receipt Preview Modal -->
    <div class="modal fade" id="receiptPreviewModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-receipt me-2"></i>
                        Receipt Preview
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="row g-0">
                        <!-- Receipt Image Preview -->
                        <div class="col-md-5 border-end">
                            <div class="receipt-image-container position-relative" style="height: 500px;">
                                <img id="receiptImage" class="img-fluid w-100 h-100 object-fit-contain" alt="Receipt">
                                <div class="position-absolute top-0 end-0 p-2">
                                    <button class="btn btn-sm btn-light me-1" onclick="rotateImage(-90)">
                                        <i class="fas fa-undo"></i>
                                    </button>
                                    <button class="btn btn-sm btn-light" onclick="rotateImage(90)">
                                        <i class="fas fa-redo"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <!-- Extracted Data -->
                        <div class="col-md-7">
                            <div class="p-3">
                                <!-- Store and Date -->
                                <div class="mb-4">
                                    <div class="form-floating mb-3">
                                        <input type="text" class="form-control" id="storeName" placeholder="Store Name">
                                        <label for="storeName">Store Name</label>
                                    </div>
                                    <div class="form-floating">
                                        <input type="date" class="form-control" id="receiptDate">
                                        <label for="receiptDate">Receipt Date</label>
                                    </div>
                                </div>
                                
                                <!-- Items List -->
                                <div class="mb-4">
                                    <h6 class="fw-bold mb-3">Items</h6>
                                    <div id="itemsList" class="list-group mb-3">
                                        <!-- Items will be added here dynamically -->
                                    </div>
                                    <button class="btn btn-outline-primary btn-sm w-100" onclick="addNewItem()">
                                        <i class="fas fa-plus me-1"></i>Add Item
                                    </button>
                                </div>
                                
                                <!-- Totals -->
                                <div class="border-top pt-3">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="text-muted">Subtotal:</span>
                                        <span id="subtotal">$0.00</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="text-muted">Tax:</span>
                                        <span id="tax">$0.00</span>
                                    </div>
                                    <div class="d-flex justify-content-between fw-bold">
                                        <span>Total:</span>
                                        <span id="total">$0.00</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="confirmReceipt()">
                        <i class="fas fa-check me-1"></i>Confirm Receipt
                    </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// File type checking functions
function isPDF(file) {
    return file.type === 'application/pdf';
}

function isImage(file) {
    const type = file.type.toLowerCase();
    return type === 'image/jpeg' || type === 'image/jpg' || type === 'image/png';
}

function getFileTypeIcon(file) {
    if (isPDF(file)) {
        return '<i class="fas fa-file-pdf text-danger"></i>';
    } else if (isImage(file)) {
        return '<i class="fas fa-receipt text-success"></i>';
    }
    return '<i class="fas fa-file text-muted"></i>';
}

function getFileTypeLabel(file) {
    if (isPDF(file)) {
        return '<span class="badge bg-danger">Bank Statement</span>';
    } else if (isImage(file)) {
        return '<span class="badge bg-success">Receipt</span>';
    }
    return '<span class="badge bg-secondary">Unknown</span>';
}

// Global variables
let files = [];

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoaded event fired');

    // File upload handling
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadForm = document.getElementById('uploadForm');
    
    console.log('Initial elements:', {
        uploadArea,
        fileInput,
        uploadBtn,
        uploadForm,
        selectedFiles: document.getElementById('selectedFiles'),
        fileList: document.getElementById('fileList')
    });
    
    // File type tracking
    let currentFileType = 'all'; // 'all', 'pdf', or 'image'
    
    // Update file input accept attribute
    function setFileType(type) {
        currentFileType = type;
        fileInput.accept = type === 'pdf' ? '.pdf' : 
                          type === 'image' ? '.jpg,.jpeg,.png' : 
                          '.pdf,.jpg,.jpeg,.png';
        updateUploadAreaText();
    }
    
    // Update upload area text based on file type
    function updateUploadAreaText() {
        const heading = document.querySelector('.upload-content h5');
        const subtext = document.querySelector('.upload-content p.text-muted');
        
        if (currentFileType === 'pdf') {
            heading.textContent = 'Drag & Drop Bank Statements Here';
            subtext.textContent = 'PDF files only';
        } else if (currentFileType === 'image') {
            heading.textContent = 'Drag & Drop Receipts Here';
            subtext.textContent = 'Image files (JPG, PNG)';
        } else {
            heading.textContent = 'Drag & Drop Files Here';
            subtext.textContent = 'Bank statements (PDF) or receipts (JPG, PNG)';
        }
    }
    

    
    // Upload area click (excluding the button area)
    uploadArea.addEventListener('click', function(e) {
        // Don't trigger if clicking on any button
        if (e.target.closest('button')) {
            return;
        }
        // Reset to accept all file types when clicking the general area
        fileInput.accept = '.pdf,.jpg,.jpeg,.png';
        updateUploadAreaText();
        fileInput.click();
    });
    
    // Drag and drop functionality
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        // If we're in a specific file type mode, check the dropped files
        const droppedFiles = Array.from(e.dataTransfer.files);
        if (currentFileType !== 'all') {
            const wrongTypeFiles = droppedFiles.filter(file => {
                const type = file.type.toLowerCase();
                if (currentFileType === 'pdf') {
                    return type !== 'application/pdf';
                } else if (currentFileType === 'image') {
                    return !['image/jpeg', 'image/jpg', 'image/png'].includes(type);
                }
                return false;
            });
            
            if (wrongTypeFiles.length > 0) {
                const expectedType = currentFileType === 'pdf' ? 'PDF files' : 'image files (JPG, PNG)';
                alert(`Currently accepting ${expectedType} only. Please use the correct file type or click the upload area to accept all types.`);
                return;
            }
        }
        
        handleFiles(droppedFiles);
    });
    
    // Initialize file input reference
    fileInput = document.getElementById('fileInput');
    
    // File input change
    fileInput.addEventListener('change', function(e) {
        console.log('File input change event triggered');
        
        if (!e.target.files || e.target.files.length === 0) {
            console.log('No files selected');
            files = [];
        } else {
            console.log('Files selected:', e.target.files.length);
            
            // Update the global files array
            files = Array.from(e.target.files);
            console.log('Files array updated:', files.length, 'files');
            
            // Filter allowed file types
            files = files.filter(file => {
                const type = file.type.toLowerCase();
                const isPDF = type === 'application/pdf';
                const isImage = type === 'image/jpeg' || type === 'image/jpg' || type === 'image/png';
                return isPDF || isImage;
            });
            
            // Show preview for image files
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    previewReceipt(file);
                }
            });
        }
        
        // Update UI
        displaySelectedFiles();
        updateUploadButton();
    });
    
    // Additional safety - ensure file input is properly reset when needed
    function resetFileInput() {
        fileInput.value = '';
        files = [];
        displaySelectedFiles();
        updateUploadButton();
    }
    
    // Receipt handling variables
    let currentReceipt = null;
    let currentRotation = 0;
    let receiptItems = [];
    
    function handleFiles(newFiles) {
        console.log('handleFiles called with', newFiles.length, 'files');
        
        // Filter allowed file types
        const allowedFiles = newFiles.filter(file => {
            console.log('Processing file:', file.name, 'type:', file.type);
            return isPDF(file) || isImage(file);
        });
        
        if (allowedFiles.length !== newFiles.length) {
            alert('Only PDF bank statements and image receipts (JPG, PNG) are allowed. Other files have been filtered out.');
        }
        
        // Update the global files array with allowed files
        files = allowedFiles;
        
        // Show preview for image files
        files.forEach(file => {
            if (file.type.startsWith('image/')) {
                previewReceipt(file);
            }
        });
        
        // Update the UI
        displaySelectedFiles();
        updateUploadButton();
    }
    
    function previewReceipt(file) {
        currentReceipt = file;
        currentRotation = 0;
        
        // Read the image file
        const reader = new FileReader();
        reader.onload = function(e) {
            // Show the image in the preview
            const img = document.getElementById('receiptImage');
            img.src = e.target.result;
            img.style.transform = 'rotate(0deg)';
            
            // Reset form fields
            document.getElementById('storeName').value = '';
            document.getElementById('receiptDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('itemsList').innerHTML = '';
            receiptItems = [];
            updateTotals();
            
            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('receiptPreviewModal'));
            modal.show();
            
            // Process the receipt with OCR (you'll implement this later)
            processReceiptOCR(file);
        };
        reader.readAsDataURL(file);
    }
    
    function rotateImage(degrees) {
        currentRotation = (currentRotation + degrees) % 360;
        const img = document.getElementById('receiptImage');
        img.style.transform = `rotate(${currentRotation}deg)`;
    }
    
    function addNewItem(name = '', amount = '', category = 'Uncategorized') {
        const itemId = Date.now();
        const itemHtml = `
            <div class="list-group-item" data-item-id="${itemId}">
                <div class="row g-2">
                    <div class="col-6">
                        <input type="text" class="form-control form-control-sm" 
                               placeholder="Item name" value="${name}"
                               onchange="updateItem(${itemId}, 'name', this.value)">
                    </div>
                    <div class="col-3">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" step="0.01" min="0"
                                   placeholder="0.00" value="${amount}"
                                   onchange="updateItem(${itemId}, 'amount', this.value)">
                        </div>
                    </div>
                    <div class="col-3">
                        <select class="form-select form-select-sm" 
                                onchange="updateItem(${itemId}, 'category', this.value)">
                            <option value="Uncategorized" ${category === 'Uncategorized' ? 'selected' : ''}>Other</option>
                            <option value="Groceries" ${category === 'Groceries' ? 'selected' : ''}>Groceries</option>
                            <option value="Food" ${category === 'Food' ? 'selected' : ''}>Food</option>
                            <option value="Shopping" ${category === 'Shopping' ? 'selected' : ''}>Shopping</option>
                            <option value="Health" ${category === 'Health' ? 'selected' : ''}>Health</option>
                            <option value="Transportation" ${category === 'Transportation' ? 'selected' : ''}>Transport</option>
                        </select>
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('itemsList').insertAdjacentHTML('beforeend', itemHtml);
        receiptItems.push({ id: itemId, name, amount: amount || 0, category });
        updateTotals();
    }
    
    function updateItem(itemId, field, value) {
        const item = receiptItems.find(i => i.id === itemId);
        if (item) {
            item[field] = field === 'amount' ? parseFloat(value) || 0 : value;
            updateTotals();
        }
    }
    
    function updateTotals() {
        const subtotal = receiptItems.reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
        const tax = subtotal * 0.1; // Assuming 10% tax
        const total = subtotal + tax;
        
        document.getElementById('subtotal').textContent = formatCurrency(subtotal);
        document.getElementById('tax').textContent = formatCurrency(tax);
        document.getElementById('total').textContent = formatCurrency(total);
    }
    
    function formatCurrency(amount) {
        return '$' + amount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }
    
    async function processReceiptOCR(file) {
        try {
            const formData = new FormData();
            formData.append('receipt', file);
            
            const response = await fetch('/api/process_receipt', {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                const data = await response.json();
                
                // Update form with extracted data
                document.getElementById('storeName').value = data.store_name || '';
                document.getElementById('receiptDate').value = data.date || new Date().toISOString().split('T')[0];
                
                // Add items
                receiptItems = [];
                document.getElementById('itemsList').innerHTML = '';
                data.items.forEach(item => {
                    addNewItem(item.name, item.amount, item.category);
                });
            }
        } catch (error) {
            console.error('Error processing receipt:', error);
        }
    }
    
    function confirmReceipt() {
        const receiptData = {
            store_name: document.getElementById('storeName').value,
            date: document.getElementById('receiptDate').value,
            items: receiptItems,
            totals: {
                subtotal: parseFloat(document.getElementById('subtotal').textContent.replace(/[$,]/g, '')),
                tax: parseFloat(document.getElementById('tax').textContent.replace(/[$,]/g, '')),
                total: parseFloat(document.getElementById('total').textContent.replace(/[$,]/g, ''))
            }
        };
        
        // Store the receipt data for submission
        const index = files.indexOf(currentReceipt);
        if (index !== -1) {
            files[index].receiptData = receiptData;
        }
        
        // Close the modal
        bootstrap.Modal.getInstance(document.getElementById('receiptPreviewModal')).hide();
    }
    }
    
    function displaySelectedFiles() {
        console.log('displaySelectedFiles called');
        console.log('Current files array:', files);
        
        const selectedFiles = document.getElementById('selectedFiles');
        const fileList = document.getElementById('fileList');
        
        console.log('Elements:', { selectedFiles, fileList });
        
        if (!selectedFiles || !fileList) {
            console.error('Required elements not found!');
            return;
        }
        
        if (files.length === 0) {
            console.log('No files selected, hiding container');
            selectedFiles.style.display = 'none';
            return;
        }
        
        console.log('Files selected, showing container');
        selectedFiles.style.display = 'block';
        fileList.innerHTML = '';
        
        // Group files by type
        const statements = files.filter(isPDF);
        const receipts = files.filter(isImage);
        
        // Display bank statements
        if (statements.length > 0) {
            const statementGroup = document.createElement('div');
            statementGroup.className = 'mb-3';
            statementGroup.innerHTML = `
                <h6 class="mb-2">
                    <i class="fas fa-file-pdf text-danger me-2"></i>
                    Bank Statements (${statements.length})
                </h6>
            `;
            statements.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                fileItem.innerHTML = `
                    <div>
                        <strong>${file.name}</strong>
                        <small class="text-muted ms-2">(${formatFileSize(file.size)})</small>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFile(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                statementGroup.appendChild(fileItem);
            });
            fileList.appendChild(statementGroup);
        }
        
        // Display receipts
        if (receipts.length > 0) {
            const receiptGroup = document.createElement('div');
            receiptGroup.className = 'mb-3';
            receiptGroup.innerHTML = `
                <h6 class="mb-2">
                    <i class="fas fa-receipt text-success me-2"></i>
                    Receipts (${receipts.length})
                </h6>
            `;
            receipts.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                fileItem.innerHTML = `
                    <div>
                        <strong>${file.name}</strong>
                        <small class="text-muted ms-2">(${formatFileSize(file.size)})</small>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-success" onclick="removeFile(${files.indexOf(file)})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                receiptGroup.appendChild(fileItem);
            });
            fileList.appendChild(receiptGroup);
        }
    }
    
    function updateUploadButton() {
        uploadBtn.disabled = files.length === 0;
        const uploadIcon = document.getElementById('uploadIcon');
        
        if (files.length > 0) {
            const statements = files.filter(isPDF);
            const receipts = files.filter(isImage);
            
            // Update main upload icon
            if (statements.length > 0 && receipts.length > 0) {
                uploadIcon.className = 'fas fa-file-upload fa-3x text-primary mb-3';
            } else if (statements.length > 0) {
                uploadIcon.className = 'fas fa-file-pdf fa-3x text-danger mb-3';
            } else {
                uploadIcon.className = 'fas fa-receipt fa-3x text-success mb-3';
            }
            
            // Update button text
            const fileCount = `${statements.length + receipts.length} File${files.length > 1 ? 's' : ''}`;
            const statementText = statements.length > 0 ? `${statements.length} Statement${statements.length > 1 ? 's' : ''}` : '';
            const receiptText = receipts.length > 0 ? `${receipts.length} Receipt${receipts.length > 1 ? 's' : ''}` : '';
            const detailText = [statementText, receiptText].filter(Boolean).join(' & ');
            
            uploadBtn.innerHTML = `
                <i class="fas fa-analytics me-2"></i>
                Analyze ${fileCount}<br>
                <small class="text-white-50">${detailText}</small>
            `;
        } else {
            // Reset to default icon
            uploadIcon.className = 'fas fa-cloud-upload-alt fa-3x text-primary mb-3';
            uploadBtn.innerHTML = `
                <i class="fas fa-analytics me-2"></i>
                Upload Files to Analyze
            `;
        }
    }
    
    window.removeFile = function(index) {
        console.log('Removing file at index:', index);
        console.log('Files before removal:', files);
        
        files.splice(index, 1);
        console.log('Files after removal:', files);
        
        // Update file input
        const dt = new DataTransfer();
        files.forEach(file => dt.items.add(file));
        fileInput.files = dt.files;
        
        // Update UI
        displaySelectedFiles();
        updateUploadButton();
    };
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // Form submission with progress
    uploadForm.addEventListener('submit', function(e) {
        if (files.length === 0) {
            e.preventDefault();
            alert('Please select at least one PDF file.');
            return;
        }
        
        // Update file input with current files
        const dt = new DataTransfer();
        files.forEach(file => dt.items.add(file));
        fileInput.files = dt.files;
        
        // Show loading state
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = `
            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
            Processing...
        `;
        
        // Create progress indicator
        const progressDiv = document.createElement('div');
        progressDiv.className = 'mt-4';
        progressDiv.innerHTML = `
            <div class="progress mb-3" style="height: 20px;">
                <div id="uploadProgress" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                     role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
            </div>
            <div id="processingSteps" class="processing-steps">
                <div class="processing-step mb-2 text-muted">
                    <i class="fas fa-file-pdf text-primary me-2"></i>
                    <span>Extracting text from PDFs</span>
                    <i class="fas fa-check text-success ms-2 d-none"></i>
                </div>
                <div class="processing-step mb-2 text-muted">
                    <i class="fas fa-tags text-primary me-2"></i>
                    <span>Categorizing transactions</span>
                    <i class="fas fa-check text-success ms-2 d-none"></i>
                </div>
                <div class="processing-step mb-2 text-muted">
                    <i class="fas fa-chart-bar text-primary me-2"></i>
                    <span>Generating reports and charts</span>
                    <i class="fas fa-check text-success ms-2 d-none"></i>
                </div>
            </div>
        `;
        uploadBtn.parentNode.appendChild(progressDiv);

        // Simulate progress for better user experience
        let currentProgress = 0;
        const steps = document.querySelectorAll('.processing-step');
        const progressBar = document.getElementById('uploadProgress');
        
        function updateProgress(progress, stepIndex) {
            currentProgress = progress;
            progressBar.style.width = `${progress}%`;
            progressBar.textContent = `${progress}%`;
            progressBar.setAttribute('aria-valuenow', progress);

            // Update step indicators
            steps.forEach((step, index) => {
                if (index < stepIndex) {
                    step.classList.remove('text-muted');
                    step.classList.add('text-success');
                    step.querySelector('.fa-check').classList.remove('d-none');
                } else if (index === stepIndex) {
                    step.classList.remove('text-muted');
                    step.classList.add('text-primary');
                }
            });
        }

        // Simulate the processing steps
        setTimeout(() => updateProgress(15, 0), 500);  // Start PDF extraction
        setTimeout(() => updateProgress(30, 0), 1500); // PDF extraction progress
        setTimeout(() => {
            updateProgress(45, 1);  // Start categorization
            steps[0].querySelector('.fa-check').classList.remove('d-none');
        }, 2500);
        setTimeout(() => updateProgress(60, 1), 3500); // Categorization progress
        setTimeout(() => {
            updateProgress(75, 2);  // Start report generation
            steps[1].querySelector('.fa-check').classList.remove('d-none');
        }, 4500);
        setTimeout(() => updateProgress(90, 2), 5500); // Report generation progress
    });
});
</script>

<style>
/* Fix for file upload button responsiveness */
#browseBtn {
    position: relative;
    z-index: 10;
    pointer-events: auto;
    transition: all 0.2s ease;
}

#browseBtn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,123,255,0.3);
}

#browseBtn:active {
    transform: translateY(0);
}

/* Upload area styling */
.upload-area {
    position: relative;
    cursor: pointer;
    background: #f8f9fa;
    border: 2px dashed #dee2e6 !important;
    border-radius: 8px !important;
    transition: all 0.3s ease;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}

.upload-area:hover {
    border-color: #2196f3 !important;
    background: #fff;
}

.upload-content {
    position: relative;
    z-index: 1;
}

.upload-content h5 {
    color: #2196f3;
    font-weight: 600;
}

/* Selected files section */
#selectedFiles {
    border-top: 2px dashed #dee2e6 !important;
    margin-left: -1.5rem;
    margin-right: -1.5rem;
    padding-left: 1.5rem;
    padding-right: 1.5rem;
}

/* File input debugging - remove in production */
#fileInput {
    position: absolute !important;
    left: -9999px !important;
    visibility: hidden !important;
}



/* Enhanced drag over effect */
.upload-area.dragover {
    background-color: #e3f2fd;
    border-color: #2196f3;
    transform: scale(1.02);
    transition: all 0.3s ease;
}

/* Receipt Preview Styles */
.receipt-image-container {
    background: #f8f9fa;
    border-radius: 8px;
    overflow: hidden;
}

.receipt-image-container img {
    transition: transform 0.3s ease;
}

.list-group-item {
    transition: all 0.3s ease;
    border-left: 3px solid transparent;
}

.list-group-item:hover {
    background-color: #f8f9fa;
    border-left-color: #2196f3;
}

.form-floating > .form-control:focus {
    border-color: #2196f3;
    box-shadow: 0 0 0 0.2rem rgba(33, 150, 243, 0.25);
}

.input-group-text {
    background-color: #e9ecef;
    border-color: #ced4da;
}

.form-select:focus {
    border-color: #2196f3;
    box-shadow: 0 0 0 0.2rem rgba(33, 150, 243, 0.25);
}

/* Category colors */
.category-groceries { color: #4caf50; }
.category-food { color: #ff9800; }
.category-shopping { color: #2196f3; }
.category-health { color: #f44336; }
.category-transportation { color: #9c27b0; }

/* Receipt modal enhancements */
.modal-dialog-scrollable .modal-content {
    border: none;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
}

.modal-header {
    border-top-left-radius: 12px;
    border-top-right-radius: 12px;
}

.btn-light {
    background: rgba(255,255,255,0.9);
    backdrop-filter: blur(5px);
    border: none;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.btn-light:hover {
    background: white;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* Processing steps styling */
.processing-steps {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    border: 1px solid #dee2e6;
}

.processing-step {
    display: flex;
    align-items: center;
    padding: 0.5rem;
    border-radius: 4px;
    transition: all 0.3s ease;
}

.processing-step.text-primary {
    background: rgba(33, 150, 243, 0.1);
}

.processing-step.text-success {
    background: rgba(40, 167, 69, 0.1);
}

.processing-step i.fa-check {
    opacity: 0;
    transform: scale(0);
    transition: all 0.3s ease;
}

.processing-step i.fa-check:not(.d-none) {
    opacity: 1;
    transform: scale(1);
}

/* Progress bar enhancements */
.progress {
    background-color: #e9ecef;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
}

.progress-bar {
    background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
    box-shadow: 0 2px 5px rgba(33, 150, 243, 0.3);
    font-weight: 600;
    font-size: 0.875rem;
    line-height: 20px;
    transition: width 0.5s ease;
}

/* Selected Files Container */
#selectedFiles {
    transition: all 0.3s ease;
    border: 1px solid #dee2e6 !important;
}

#selectedFiles:not([style*="display: none"]) {
    margin-top: 2rem !important;
    margin-bottom: 1rem !important;
}

#selectedFiles .list-group-item {
    border-left: 3px solid transparent;
    transition: all 0.2s ease;
}

#selectedFiles .list-group-item:hover {
    background-color: #f8f9fa;
    transform: translateX(3px);
}

/* File type specific styles */
#selectedFiles .list-group-item.pdf-file {
    border-left-color: #dc3545;
}

#selectedFiles .list-group-item.image-file {
    border-left-color: #28a745;
}
</style>
{% endblock %}
